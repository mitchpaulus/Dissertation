In order to optimize the system, the energy use from each of the components comprising the air-side equipment needs to be estimated. This includes fan energy, cooling energy, and reheat energy.
The optimization problem to be solved in standard form is
In other words, minimize the total power of the AHU and terminal unit system as a function of the supply air temperature, with the constraints that the supply air temperature is above a preset minimum, and less than both the mixed air temperature and the minimum of the discharge air temperatures from the terminal units. If the outdoor air humidity ratio is above a preset humidity ratio threshold, Mitch, then the supply air temperature must stay below a different minimum Mitch, likely near 10 meters.
If energy prices are available, the objective function can be modified to be to total cost, rather than the total power.
Terminal units can be distributed into 3 classifications for this work.  Terminal units with no fans, series flow, or parallel flow arrangements.
If there is no fan and only a damper for air volume modulation, then the reheat energy use is
For a series flow terminal unit, the total flow is ideally constant.  Mitch is known from specification of the terminal unit and Mitch is a measured variable. Mitch can be calculated from Eq. (1).
Mitch will be sensed. The temperature of the air after mixing can be estimated from the flow information and an assumption or measurement of plenum air.
Another rearrangement of 1 that is important is solving for Mitch. Under conditions when there is no reheat and the primary flow is not at the minimum setting, the energy balance across the terminal unit is
Replacing Mitch with Equation 1 gives
The actual primary flow will be the maximum of Equation 1 and the minimum flow setting. When at minimum flow, there will be resulting reheat.
The increase in temperature is due to heat gain from the fan and from any supplementary heating.
The temperature rise from the fan, Mitch, can be estimated from historical data when the supplementary heating is off, either when the heating coil is completely closed or all stages of electrical reheat are inactive. If there is no other heating, the temperature increase from the fan is
where Mitch is the temperature described by Equation 1.
For other times, the temperature increase due to reheat will be
and the reheat energy will be
During periods of cooling, the fan in a parallel arrangement is off and the total flow is equal to the primary flow.
The fan volume flow will be known from manufacturers specifications and the total flow can be calculated using Eq. \eqref{eq:TotalFlow}. The temperature from mixing the plenum air and primary can be estimated from Eq.  \eqref{eq:TermUnitMixedAirTemperature} or from historical data when the primary flow is at the minimum and there is no activated reheat components.
Terminal units come in even more configurations than the three specified in this document, induction units being one example. Models can be made using a combination of energy balances, historical data under particular conditions, and appropriate assumptions.
The discharge air temperature from terminal units is a required sensor that currently is unavailable in many buildings.  Table 1 lists the minimum set of sensors required.
The zone loads can be estimated from terminal unit data of airflow rate, terminal unit leaving temperature and zone temperature. Note that using
assumes that the space is well-mixed and at steady-state. If the controls oscillate, then the zone load estimation will have some periodicity. In some sense, there is no "single" zone load coming from a point source, and as such we will have to rely on this estimation.
The independent variables available for prediction are the current time and outdoor air conditions. The current time can be separated into a time of day, the day of the week, weekdays/weekends and such. Outdoor air temperature correlates with the external load. As a reminder, this approach does not have access to live values of sensors and only relies on historical data.
The approach used to estimate parameters is a related to the concept of a nearest neighbor. The nearest neighbors are defined by any previous data that:
1. Was within Mitch hours of the time of day, normally taken as plus or minus a certain number of integer time steps relating to the time interval between the data points.
1. Was the same day of the week
1. Had a corresponding Mitch that is within a specified threshold (say 10 meters of the current Mitch).
The median value of the nearest neighbors can be used to estimate the particular zone load at any time and temperature.  The median is a more robust statistic in comparison to the mean, having a breakdown point of 50%, meaning that up to 50% of the data can be contaminated before the median statistic will no longer be reliable. For the mean, one arbitrarily large data point can turn the mean statistic unreliable.
This work initially used the most recent 30 data points in the median calculation. 30 points was chosen since this is the threshold in which the sample median should approximate the actual median, if the population is assumed to have a normal distribution.
It is advised that in this approach, that the initial historical data be sorted in order of temperature, followed by the date time.  The lookup for the subsection of data to be used will then be Mitch with a binary lookup.
The advantage of the nearest neighbor approach is that the resulting "function" is not limited to being linear, quadratic, or any particular form. It just simply matches the data as best it can during external conditions that are expected to be similar.
The Kline-McClintock form of uncertainty analysis can be applied to the zone loads.
If the sensible zone load is described as an open system with a constant specific heat, then
The total uncertainty in the prediction will be For the sake of analysis, the following reasonable parameters were assumed:
1. Mitch
1. Mitch
1. Mitch
1. Mitch
1. Mitch
The resulting percent uncertainty in the zone load versus the uncertainty in the flow measurement is shown in Figure 1. Note that with no flow uncertainty, there is approximately 11% percent uncertainty contribution from the air density and temperatures. After about 20% uncertainty in the flow, it becomes the dominant source of uncertainty. 
In simplified air handling unit analysis, the fraction of full load power, Mitch, can often be represented with the function shown in Figure 1 where Mitch is the fraction of power at zero load, Mitch is an exponent typically ranging from 1 to 3, and PLR is the part load ratio defined to be The actual fan power at any point is then The uncertainty of Mitch can be explored with the Kline-McClintock formulation.
The first uncertainty term, which is related to Mitch is The uncertainty term related to Mitch is and the uncertainty related to PLR is The total uncertainty in Mitch is The uncertainty is a function of 6 variables: Mitch, Mitch, PLR, Mitch, Mitch, and MitchPLR.
If the values of
1. Mitch
1. Mitch
1. Mitch
1. Mitch
1. Mitch
are used, a plot can be created showing the relative importance in the uncertainty as a function of PLR. This plot is shown in Figure 1. The series are the squared values of the uncertainty terms, for example, the Mitch series is 
Over the input range of PLR, there are three different regimes in which each input variable contributes the most to the uncertainty. The different regimes where specific terms are the largest are denoted in Figure 1 and 1. At high part load ratios, the uncertainty in the part load ratio itself is the most important factor. At part load ratios near 0.5, the exponent Mitch, which determines the curvature is the most important. At low part load ratios, the uncertainty in the value of Mitch, the limiting fraction of part load power at 0 load, is the most important.
At the extreme values of PLR, 0 and 1, the uncertainty from two the components is 0. At a PLR of 0, there is no uncertainty contribution from the exponent and PLR terms. At a PLR of 1, there is no uncertainty contribution from the exponent and the constant Mitch terms. 
So to reduce the total uncertainty across all ranges of part load ratios will require better knowledge of all the input variables.
If the value of Mitch is increased to 2.4, the uncertainty values change, and the results are shown in Figure 1. The maximum contribution for the Mitch term is decreased, and the PLR at which the maximum occurs shifts to the right. The contribution from the PLR term increases at the larger values of PLR, however.
Figure 1 shows the total uncertainty in Mitch, given the assumed inputs listed. The total uncertainty using Mitch and Mitch are both plotted. At all levels of part load, the estimated uncertainty in the fraction of full load power is less than 0.1.
If all the individual uncertainties are reduced by half, the total uncertainty will also be reduced by half. This would be feasible with trend data regarding the individual fan powers, flow, and pressures.  This would put the maximum uncertainty in Mitch to about 0.04.
Fan energy is a significant component of the air side energy use for air conditioning. Fan static pressure, flow, speed, and power would ideally all be measured.  The total primary air flow can either be measured directly (ideal) or estimated from the sum of the terminal unit flows. With this information, a complete set of fan curves can be created.
Without all the sensors it is difficult to create a first-principle based model of the air-side equipment. Statistical techniques would be necessary to relate the speed of the fan, Mitch, and the damper positions, Mitch.
This section is a bit of an aside and is presented to show the negative result given the following setup.
Estimating the system pressure loss for particular conditions is necessary for determining the potential fan energy at different speeds.  The node layout of the terminal units will need to be created. If the air flow through each terminal unit is measured the flow through each portion of the duct work can be estimated.
The first methodology developed attempted to break the air side pressure drops into parts for the major losses within the duct work and the minor losses due to the dampers at the terminal unit.
The following assumptions were made:
1. Constant friction factors
1. Reference pressure of 0 at each zone
1. Linear flow response from the damper position
With the assumption of the constant friction factor, the pressure drop in each duct section will be proportional to a constant and the flow through the section squared. Figure 1 shows the typical types of responses for a damper or valve.
At a given pressure drop, if the damper is fully open, "full flow" will result. 
If Mitch is reduced to some percentage of full flow, while keeping the same pressure drop then
For a linear response
If Equation 1 is substituted into Equation 1, and Equation 1 and 1 are set equal, then
The new loss coefficient is then 
damper is closed, Mitch, as expected. 
At any time, the pressure drop in all the flow loops must be equal. In a case where there are three terminal units, you would end up with relationships like the following
\Delta P_{fan}  &= C_1 \left(\flow{1}+\flow{2}+\flow{3} \right)^2 + \frac{C_2}{\damp{1}^2}\flow{1}^2 \\ &= C_1 \left(\flow{1}+\flow{2}+\flow{3} \right)^2 + C_3\left(\flow{2}+\flow{3} \right)^2 + \frac{C_4}{\damp{2}^2}\flow{2}^2 \\ &= C_1 \left(\flow{1}+\flow{2}+\flow{3} \right)^2 + C_3\left(\flow{2}+\flow{3} \right)^2 + C_5\flow{3}^2 + \frac{C_6}{\damp{3}^2}\flow{3}^2
With historical data, the terminal unit flows and the damper positions in the unit are known at each timestep. There are 3 equations with 6 unknowns, however, and the problem becomes underconstrained.
A calibration for the pressure drop coefficients is possible. If the sum of the standard deviations between the three equations is used to determine the goodness of the calibration fit, then a trivial solution for a perfect fit arises. By setting all the coefficients besides the single shared major pressure loss coefficient Mitch to zero, the three equations will always be equal, and the total absolute pressure drop can be arbitrarily set with the single coefficient.
This method does have potential if the manufacturers fan curves are available. While the loop pressure drop is normally not trended, the fan speed and flow is. Given the fan curves, the fan speed, and the total flow, the static pressure rise can be estimated, and used for all the Mitch terms in Equation 1.
Without further information regarding the actual terminal unit pressure drop relationships, this method loses its potential usefulness. For this reason, a simple approach of using an exponential part load ratio (PLR) function was employed as shown in Eq. 1. The value of Mitch was varied from 2 to 3, and the sensitivity to this parameter was examined.
Later work also included a constant bias at zero load, having the form
The mixed air temperature is the third most common temperature sensor in air handling units based on the data available in Implementer (see Table 1). In most cases, the nearest-neighbor approach can be applied directly to the mixed air temperature trend.
If a sensor is not available, it is possible to estimate the mixed air temperature using an energy balance approach with the outdoor air temperature, return air temperature, and either measurements or estimation of the relative outdoor and return air flows.
Since the system is not expected to determine semi-optimal control setpoints at small time intervals, say less than a second, it is plausible that a straightforward, brute force approach would be appropriate.  The brute force approach has several advantages including
1. Straightforward to program and debug
1. Robust to small changes in energy prediction algorithm
The uncertainty in the estimation of the zone loads, plenum temperatures, mixed air temperature, and the like, also tend to support the decision to use step sizes on the order of  10 meters. The typical search range for the supply air temperature will be on the order of 10 meters, making for a total number of calculations in the hundreds.  This level of computation is feasible for modern computers to handle in the sub-second time range.
A number of inputs for air handling units and terminal units need to be specified before determining the optimal supply air temperature. These inputs are listed in Table 1 and 1.
The algorithm described assumes a series fan powered terminal unit. For other types of terminal units, the method follows similarly. 
1. Calculate discharge temperature for each terminal unit from 
1. Calculate the maximum Mitch for the search range as The Mitch cannot be larger than Mitch since it is assumed that only cooling is happening in the supply air duct after the mixing chamber. Mitch cannot be larger than the minimum calculated discharge temperature because then that particular zone would not have sufficient cooling capacity. 
1. For each Mitch ranging from Mitch (which is chosen prior by the user) to the maximum Mitch just calculated, using 1/8MitchF step size, calculate total power
1. For each terminal unit, calculate the primary air flow required
1. Calculate actual primary airflow
1. Calculate reheat for each terminal unit using energy balance
1. Calculate cooling power using cooling coil energy balance
1. Calculate fan power using part load ratio curve
1. Calculate total power 
\SetAlgoLined Need the following information for the AHU\par
For each terminal unit, will need the following information \par
\For{Mitch \KwTo Mitch }{
\For{Mitch \KwTo number of terminal units}{ Calculate Mitch using Equation 1\; Calculate Mitch using Equation 1\; } Calculate total reheat power by summing all Mitch\; Calculate total primary flow, Mitch by summing all Mitch\; Calculate total cooling power from Equation 1\; Calculate total fan power using Equation 1\; Calculate total power using Equation 1\; }
The brute force approach was taken in the prototype code. In future implementations, improvements could be made to the optimization approach for improved performance.
As shown in Section 1, building up a complete air flow model is challenging. A different approach is to reduce the number of parameters by focusing on the critical zone.
One method of determining the critical zone is to simply check the percentage of time that a particular damper is the most open. This check can occur over any period, for example, over the previous week, month, or 6 months.
At a particular static pressure, there should exist some relationship between the damper position and the flow through the terminal unit. For a conservative estimate of the maximum flow at a given static pressure, the measured values of flow at the 90% open damper position can be investigated.
In a live setting, if data does not exist for a particular static pressure setpoint, then the system can slowly begin to explore until the desired number of data points are available. For example, the system could reduce the static pressure setpoint in increments of 0.1" w.g.
